from aiogram.utils.keyboard import InlineKeyboardBuilder

# Callback data formats:
# order:go:{external_id}
# order:later:{external_id}
# order:done:{external_id}
# order:problem:{external_id}

def new_order_kb(external_id: str):
    b = InlineKeyboardBuilder()
    b.button(text="‚ñ∂ –ü–æ–µ—Ö–∞–ª–∏", callback_data=f"order:go:{external_id}")
    b.button(text="‚è± –í–æ–∑—å–º—É –ø–æ–∑–∂–µ", callback_data=f"order:later:{external_id}")
    b.adjust(2)
    return b.as_markup()

def in_transit_kb(external_id: str, order: dict = None):
    """
    –°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –∑–∞–∫–∞–∑–∞ –≤ –ø—É—Ç–∏.
    
    –ü–†–ê–í–ò–õ–û –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–ù–û–ü–û–ö –û–ü–õ–ê–¢–´:
    ===================================
    
    1. –ï—Å–ª–∏ payment_status == "PAID" (–æ–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞):
       ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "‚úÖ –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω"
       ‚Üí –ö—É—Ä—å–µ—Ä –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑
    
    2. –ï—Å–ª–∏ payment_status == "NOT_PAID" (–æ–ø–ª–∞—Ç–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞):
       
       a) –ï—Å–ª–∏ –µ—Å—Ç—å client_ip (–∑–∞–∫–∞–∑ —Å IP-–∞–¥—Ä–µ—Å–æ–º –∫–ª–∏–µ–Ω—Ç–∞):
          ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "‚úÖ –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω" —Å—Ä–∞–∑—É
          ‚Üí –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "üîç –ü—Ä–æ–≤–µ—Ä—å –æ–ø–ª–∞—Ç—É" –∏ "üí∞ –ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É"
          ‚Üí –õ–æ–≥–∏–∫–∞: –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ —Å client_ip –æ–ø–ª–∞—Ç–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏,
            –∫—É—Ä—å–µ—Ä –º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã
       
       b) –ï—Å–ª–∏ is_cash_payment == True (–∑–∞–∫–∞–∑ —Å –æ–ø–ª–∞—Ç–æ–π –Ω–∞–ª–∏—á–Ω—ã–º–∏):
          ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "üí∞ –ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É"
          ‚Üí –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "üîç –ü—Ä–æ–≤–µ—Ä—å –æ–ø–ª–∞—Ç—É"
          ‚Üí –õ–æ–≥–∏–∫–∞: –¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å "–æ–ø–ª–∞—á–µ–Ω–æ" –≤ Odoo
            –¥–æ –≤—Å—Ç—Ä–µ—á–∏ –∫—É—Ä—å–µ—Ä–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º. –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ Odoo –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–∞.
            –ö—É—Ä—å–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É –Ω–∞–ª–∏—á–Ω—ã–º–∏, —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –∫—É–ø—é—Ä—ã,
            –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω.
       
       c) –ï—Å–ª–∏ is_cash_payment == False (–∑–∞–∫–∞–∑ –±–µ–∑ –Ω–∞–ª–∏—á–Ω—ã—Ö, –æ–ø–ª–∞—Ç–∞ –æ–Ω–ª–∞–π–Ω/–∫–∞—Ä—Ç–æ–π):
          ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "üîç –ü—Ä–æ–≤–µ—Ä—å –æ–ø–ª–∞—Ç—É"
          ‚Üí –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "üí∞ –ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É"
          ‚Üí –õ–æ–≥–∏–∫–∞: –¥–ª—è –Ω–µ –Ω–∞–ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –æ–ø–ª–∞—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –≤ Odoo
            –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–æ –≤—Å—Ç—Ä–µ—á–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º. –ö—É—Ä—å–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ Odoo,
            –∏ –µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ - –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑.
    
    –í–ê–ñ–ù–û:
    - –î–ª—è –∑–∞–∫–∞–∑–æ–≤ —Å client_ip –∫–Ω–æ–ø–∫–∞ "‚úÖ –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ NOT_PAID
    - –ö–Ω–æ–ø–∫–∞ "üí∞ –ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —Å NOT_PAID (–±–µ–∑ client_ip)
    - –ö–Ω–æ–ø–∫–∞ "üîç –ü—Ä–æ–≤–µ—Ä—å –æ–ø–ª–∞—Ç—É" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –Ω–µ –Ω–∞–ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —Å NOT_PAID (–±–µ–∑ client_ip)
    - –≠—Ç–∏ –∫–Ω–æ–ø–∫–∏ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    """
    b = InlineKeyboardBuilder()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
    payment_status = order.get("payment_status") if order else None
    is_cash_payment = order.get("is_cash_payment", False) if order else False
    has_client_ip = bool(order.get("client_ip")) if order else False
    
    if payment_status == "NOT_PAID":
        # –ó–∞–∫–∞–∑ –Ω–µ –æ–ø–ª–∞—á–µ–Ω - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫—É—é –∫–Ω–æ–ø–∫—É –ø–æ–∫–∞–∑–∞—Ç—å
        
        if has_client_ip:
            # –ü–†–ê–í–ò–õ–û: –î–ª—è –∑–∞–∫–∞–∑–æ–≤ —Å client_ip –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –æ–ø–ª–∞—Ç—ã
            # –û–ø–ª–∞—Ç–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫—É—Ä—å–µ—Ä –º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑
            b.button(text="‚úÖ –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω", callback_data=f"order:done:{external_id}")
        elif is_cash_payment:
            # –ü–†–ê–í–ò–õ–û: –î–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —Å NOT_PAID –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É"
            # –ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–æ –≤ Odoo –¥–æ –≤—Å—Ç—Ä–µ—á–∏ –∫—É—Ä—å–µ—Ä–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º
            # –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ Odoo –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–∞ - –∫—É—Ä—å–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É —Å–∞–º
            b.button(text="üí∞ –ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É", callback_data=f"order:accept_payment:{external_id}")
        else:
            # –ü–†–ê–í–ò–õ–û: –î–ª—è –Ω–µ –Ω–∞–ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —Å NOT_PAID –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ü—Ä–æ–≤–µ—Ä—å –æ–ø–ª–∞—Ç—É"
            # –û–ø–ª–∞—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –≤ Odoo –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–æ –≤—Å—Ç—Ä–µ—á–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º
            # –ö—É—Ä—å–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ Odoo —á–µ—Ä–µ–∑ —ç—Ç—É –∫–Ω–æ–ø–∫—É
            b.button(text="üîç –ü—Ä–æ–≤–µ—Ä—å –æ–ø–ª–∞—Ç—É", callback_data=f"order:check_payment:{external_id}")
    else:
        # –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ (PAID) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
        b.button(text="‚úÖ –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω", callback_data=f"order:done:{external_id}")
    
    # –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–∫–∞–∑–æ–º" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞
    b.button(text="‚ö† –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–∫–∞–∑–æ–º", callback_data=f"order:problem:{external_id}")
    b.adjust(2)
    return b.as_markup()
